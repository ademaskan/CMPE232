@page "/financial_records/delete"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using DataAccess
@inject IDbContextFactory<DanceAcademy.Data.DanceAcademyContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Delete Financial Record</PageTitle>

<div class="page-header page-header-delete">
    <div>
        <h1>Delete Financial Record</h1>
        <p class="page-subtitle">This action cannot be undone</p>
    </div>
</div>

@if (financial_record is null)
{
    <div class="loading-spinner">
        <div class="spinner"></div>
        <p>Loading record...</p>
    </div>
}
else
{
    <div class="details-container">
        <div class="details-card">
            <div class="warning-box">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <div>
                    <strong>Warning!</strong>
                    <p>You are about to permanently delete this financial record. This will remove all associated transaction data.</p>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Record to Delete</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-label">Branch</span>
                        <span class="detail-value">@branchName</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Member</span>
                        <span class="detail-value">@(memberName ?? "N/A")</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Amount</span>
                        <span class="@GetAmountBadgeClass(financial_record.transaction_type)">
                            @FormatCurrency(financial_record.amount, financial_record.transaction_type)
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Payment Date</span>
                        <span class="detail-value">@financial_record.payment_date.ToString("MMMM dd, yyyy")</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Payment Method</span>
                        <span class="badge-payment">@financial_record.payment_method</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Transaction Type</span>
                        <span class="@GetTransactionBadgeClass(financial_record.transaction_type)">@financial_record.transaction_type</span>
                    </div>
                </div>
            </div>
            
            <EditForm Model="financial_record" OnValidSubmit="DeleteFINANCIAL_RECORD" class="form-actions">
                <a href="/financial_records" class="btn-action btn-secondary">Cancel</a>
                <button type="submit" class="btn-action btn-danger">Delete Record</button>
            </EditForm>
        </div>
    </div>
}

@code {
    private FINANCIAL_RECORD? financial_record;
    private string? branchName;
    private string? memberName;

    [SupplyParameterFromQuery]
    private int ID { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        
        var data = await context.FINANCIAL_RECORD
            .Where(fr => fr.ID == ID)
            .Select(fr => new 
            {
                Record = new FINANCIAL_RECORD
                {
                    ID = fr.ID,
                    BRANCHID = fr.BRANCHID,
                    MEMBERID = fr.MEMBERID,
                    amount = fr.amount,
                    payment_date = fr.payment_date,
                    payment_method = fr.payment_method,
                    transaction_type = fr.transaction_type
                },
                BranchName = fr.BRANCH.branch_name,
                MemberName = fr.MEMBER != null ? fr.MEMBER.member_first_name + " " + fr.MEMBER.member_last_name : null
            })
            .FirstOrDefaultAsync();

        if (data is null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        financial_record = data.Record;
        branchName = data.BranchName;
        memberName = data.MemberName;
    }

    private async Task DeleteFINANCIAL_RECORD()
    {
        using var context = DbFactory.CreateDbContext();
        context.FINANCIAL_RECORD.Remove(financial_record!);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/financial_records");
    }

    private string FormatCurrency(decimal amount, string transactionType)
    {
        var prefix = transactionType?.ToLower() == "expense" ? "-" : "+";
        return $"{prefix}${amount:N2}";
    }

    private string GetAmountBadgeClass(string transactionType)
    {
        return transactionType?.ToLower() switch
        {
            "expense" => "badge-loss",
            "income" => "badge-profit",
            "payment" => "badge-profit",
            _ => "badge-revenue"
        };
    }

    private string GetTransactionBadgeClass(string transactionType)
    {
        return transactionType?.ToLower() switch
        {
            "expense" => "badge-expense",
            "income" => "badge-income",
            "payment" => "badge-payment-type",
            "refund" => "badge-refund",
            _ => "badge-status"
        };
    }
}
