@page "/financial_records/edit"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using DataAccess
@inject IDbContextFactory<DanceAcademy.Data.DanceAcademyContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Edit Financial Record</PageTitle>

<div class="page-header">
    <div>
        <h1>Edit Financial Record</h1>
        <p class="page-subtitle">Update payment transaction details</p>
    </div>
</div>

@if (FINANCIAL_RECORD is null)
{
    <div class="loading-spinner">
        <div class="spinner"></div>
        <p>Loading record...</p>
    </div>
}
else
{
    <div class="form-container">
        <EditForm Model="FINANCIAL_RECORD" OnValidSubmit="UpdateFINANCIAL_RECORD" class="modern-form">
            <DataAnnotationsValidator />
            <ValidationSummary class="validation-summary" role="alert"/>
            <input type="hidden" name="FINANCIAL_RECORD.ID" value="@FINANCIAL_RECORD.ID" />
            
            <div class="form-section">
                <h3>Transaction Details</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="branchid">Branch</label>
                        <InputSelect id="branchid" @bind-Value="FINANCIAL_RECORD.BRANCHID" class="form-control">
                            <option value="0">-- Select Branch --</option>
                            @if (branches != null)
                            {
                                @foreach (var branch in branches)
                                {
                                    <option value="@branch.ID">@branch.branch_name</option>
                                }
                            }
                        </InputSelect>
                        <ValidationMessage For="() => FINANCIAL_RECORD.BRANCHID" class="field-validation-error" />
                    </div>
                    
                    <div class="form-group">
                        <label for="memberid">Member (Optional)</label>
                        <InputSelect id="memberid" @bind-Value="selectedMemberId" class="form-control">
                            <option value="">-- No Member --</option>
                            @if (members != null)
                            {
                                @foreach (var member in members)
                                {
                                    <option value="@member.ID">@member.member_first_name @member.member_last_name</option>
                                }
                            }
                        </InputSelect>
                        <ValidationMessage For="() => FINANCIAL_RECORD.MEMBERID" class="field-validation-error" />
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Payment Information</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="amount">Amount</label>
                        <InputNumber id="amount" @bind-Value="FINANCIAL_RECORD.amount" class="form-control" />
                        <ValidationMessage For="() => FINANCIAL_RECORD.amount" class="field-validation-error" />
                    </div>
                    
                    <div class="form-group">
                        <label for="payment_date">Payment Date</label>
                        <InputDate id="payment_date" @bind-Value="FINANCIAL_RECORD.payment_date" class="form-control" />
                        <ValidationMessage For="() => FINANCIAL_RECORD.payment_date" class="field-validation-error" />
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="payment_method">Payment Method</label>
                        <InputSelect id="payment_method" @bind-Value="FINANCIAL_RECORD.payment_method" class="form-control">
                            <option value="">-- Select Method --</option>
                            <option value="Cash">Cash</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Debit Card">Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Check">Check</option>
                            <option value="Online Payment">Online Payment</option>
                        </InputSelect>
                        <ValidationMessage For="() => FINANCIAL_RECORD.payment_method" class="field-validation-error" />
                    </div>
                    
                    <div class="form-group">
                        <label for="transaction_type">Transaction Type</label>
                        <InputSelect id="transaction_type" @bind-Value="FINANCIAL_RECORD.transaction_type" class="form-control">
                            <option value="">-- Select Type --</option>
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                            <option value="Payment">Payment</option>
                            <option value="Refund">Refund</option>
                        </InputSelect>
                        <ValidationMessage For="() => FINANCIAL_RECORD.transaction_type" class="field-validation-error" />
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <a href="/financial_records" class="btn-action btn-secondary">Cancel</a>
                <button type="submit" class="btn-action btn-primary">Save Changes</button>
            </div>
        </EditForm>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    private int ID { get; set; }

    private FINANCIAL_RECORD? FINANCIAL_RECORD { get; set; }
    private List<BRANCH>? branches;
    private List<MEMBER>? members;

    private string? selectedMemberId
    {
        get => FINANCIAL_RECORD?.MEMBERID?.ToString() ?? "";
        set
        {
            if (FINANCIAL_RECORD != null)
            {
                if (string.IsNullOrEmpty(value))
                    FINANCIAL_RECORD.MEMBERID = null;
                else if (int.TryParse(value, out int id))
                    FINANCIAL_RECORD.MEMBERID = id;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        
        branches = await context.BRANCH.OrderBy(b => b.branch_name).ToListAsync();
        members = await context.MEMBER.OrderBy(m => m.member_first_name).ThenBy(m => m.member_last_name).ToListAsync();
        
        FINANCIAL_RECORD = await context.FINANCIAL_RECORD
            .Where(fr => fr.ID == ID)
            .Select(fr => new FINANCIAL_RECORD
            {
                ID = fr.ID,
                BRANCHID = fr.BRANCHID,
                MEMBERID = fr.MEMBERID,
                amount = fr.amount,
                payment_date = fr.payment_date,
                payment_method = fr.payment_method,
                transaction_type = fr.transaction_type
            })
            .FirstOrDefaultAsync();

        if (FINANCIAL_RECORD is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private async Task UpdateFINANCIAL_RECORD()
    {
        using var context = DbFactory.CreateDbContext();
        context.Attach(FINANCIAL_RECORD!).State = EntityState.Modified;

        try
        {
            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!FINANCIAL_RECORDExists(FINANCIAL_RECORD!.ID))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }

        NavigationManager.NavigateTo("/financial_records");
    }

    private bool FINANCIAL_RECORDExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return context.FINANCIAL_RECORD.Any(e => e.ID == id);
    }
}
