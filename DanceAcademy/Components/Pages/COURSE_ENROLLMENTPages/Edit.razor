@page "/course_enrollments/edit"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using DataAccess
@inject IDbContextFactory<DanceAcademy.Data.DanceAcademyContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Edit Enrollment - Dance Academy</PageTitle>

<div class="page-header">
    <h1><i class="bi bi-pencil-square me-2"></i>Edit Enrollment</h1>
    <p>Update enrollment details</p>
</div>

@if (Enrollment is null)
{
    <div class="loading-spinner">
        <div class="spinner"></div>
        <span>Loading enrollment details...</span>
    </div>
}
else
{
    <EditForm Model="Enrollment" OnValidSubmit="UpdateEnrollment" FormName="EditEnrollment">
        <DataAnnotationsValidator />
        <ValidationSummary class="alert alert-danger" role="alert"/>
        <input type="hidden" name="Enrollment.ID" value="@Enrollment.ID" />
        
        <div class="form-section">
            <h3 class="form-section-title"><i class="bi bi-person me-2"></i>Member</h3>
            <div class="mb-3">
                <label for="memberid" class="form-label">Select Member</label>
                <InputSelect id="memberid" @bind-Value="Enrollment.MEMBERID" class="form-control">
                    <option value="0">Select a member...</option>
                    @if (members != null)
                    {
                        @foreach (var member in members)
                        {
                            <option value="@member.ID">@member.member_first_name @member.member_last_name</option>
                        }
                    }
                </InputSelect>
                <ValidationMessage For="() => Enrollment.MEMBERID" class="text-danger" />
            </div>
        </div>

        <div class="form-section">
            <h3 class="form-section-title"><i class="bi bi-mortarboard me-2"></i>Course</h3>
            <div class="mb-3">
                <label for="course_categoryid" class="form-label">Select Course Category</label>
                <InputSelect id="course_categoryid" @bind-Value="Enrollment.COURSE_CATEGORYID" class="form-control">
                    <option value="0">Select a course...</option>
                    @if (courses != null)
                    {
                        @foreach (var course in courses)
                        {
                            <option value="@course.ID">@course.course_category_name</option>
                        }
                    }
                </InputSelect>
                <ValidationMessage For="() => Enrollment.COURSE_CATEGORYID" class="text-danger" />
            </div>
        </div>

        <div class="form-section">
            <h3 class="form-section-title"><i class="bi bi-calendar me-2"></i>Enrollment Details</h3>
            <div class="form-row">
                <div class="mb-3">
                    <label for="enrollment_date" class="form-label">Enrollment Date</label>
                    <InputDate id="enrollment_date" @bind-Value="Enrollment.enrollment_date" class="form-control" />
                    <ValidationMessage For="() => Enrollment.enrollment_date" class="text-danger" />
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg"></i> Save Changes
            </button>
            <a href="/course_enrollments" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
        </div>
    </EditForm>
}

@code {
    [SupplyParameterFromQuery]
    private int ID { get; set; }

    private COURSE_ENROLLMENT? Enrollment { get; set; }
    private List<MEMBER>? members;
    private List<COURSE_CATEGORY>? courses;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        
        members = await context.MEMBER
            .Select(m => new MEMBER { ID = m.ID, member_first_name = m.member_first_name, member_last_name = m.member_last_name })
            .ToListAsync();
        courses = await context.COURSE_CATEGORY
            .Select(c => new COURSE_CATEGORY { ID = c.ID, course_category_name = c.course_category_name })
            .ToListAsync();

        Enrollment = await context.COURSE_ENROLLMENT
            .Where(ce => ce.ID == ID)
            .Select(ce => new COURSE_ENROLLMENT
            {
                ID = ce.ID,
                MEMBERID = ce.MEMBERID,
                COURSE_CATEGORYID = ce.COURSE_CATEGORYID,
                enrollment_date = ce.enrollment_date
            })
            .FirstOrDefaultAsync();

        if (Enrollment is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private async Task UpdateEnrollment()
    {
        using var context = DbFactory.CreateDbContext();
        context.Attach(Enrollment!).State = EntityState.Modified;

        try
        {
            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!EnrollmentExists(Enrollment!.ID))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }

        NavigationManager.NavigateTo("/course_enrollments");
    }

    private bool EnrollmentExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return context.COURSE_ENROLLMENT.Any(e => e.ID == id);
    }
}
