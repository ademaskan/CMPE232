@page "/course_categories/edit"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using DataAccess
@inject IDbContextFactory<DanceAcademy.Data.DanceAcademyContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Edit Category - Dance Academy</PageTitle>

<div class="page-header">
    <h1><i class="bi bi-pencil-square me-2"></i>Edit Category</h1>
    <p>Update category details</p>
</div>

@if (Category is null)
{
    <div class="loading-spinner">
        <div class="spinner"></div>
        <span>Loading category details...</span>
    </div>
}
else
{
    <EditForm Model="Category" OnValidSubmit="UpdateCategory" FormName="EditCategory">
        <DataAnnotationsValidator />
        <ValidationSummary class="alert alert-danger" role="alert"/>
        <input type="hidden" name="Category.ID" value="@Category.ID" />
        
        <div class="form-section">
            <h3 class="form-section-title"><i class="bi bi-collection me-2"></i>Category Information</h3>
            <div class="mb-3">
                <label for="course_category_name" class="form-label">Category Name</label>
                <InputText id="course_category_name" @bind-Value="Category.course_category_name" class="form-control" placeholder="e.g. Ballet, Hip Hop, Contemporary" />
                <ValidationMessage For="() => Category.course_category_name" class="text-danger" />
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <InputTextArea id="description" @bind-Value="Category.description" class="form-control" rows="4" placeholder="Describe the dance style, level, and what students will learn..." />
                <ValidationMessage For="() => Category.description" class="text-danger" />
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg"></i> Save Changes
            </button>
            <a href="/course_categories" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
        </div>
    </EditForm>
}

@code {
    [SupplyParameterFromQuery]
    private int ID { get; set; }

    private COURSE_CATEGORY? Category { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        Category = await context.COURSE_CATEGORY
            .Where(c => c.ID == ID)
            .Select(c => new COURSE_CATEGORY
            {
                ID = c.ID,
                course_category_name = c.course_category_name,
                description = c.description
            })
            .FirstOrDefaultAsync();

        if (Category is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private async Task UpdateCategory()
    {
        using var context = DbFactory.CreateDbContext();
        context.Attach(Category!).State = EntityState.Modified;

        try
        {
            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!CategoryExists(Category!.ID))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }

        NavigationManager.NavigateTo("/course_categories");
    }

    private bool CategoryExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return context.COURSE_CATEGORY.Any(e => e.ID == id);
    }
}
