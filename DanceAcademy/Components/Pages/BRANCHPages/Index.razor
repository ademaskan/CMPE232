@page "/branches"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using DataAccess
@using DanceAcademy.Data
@implements IAsyncDisposable
@inject IDbContextFactory<DanceAcademy.Data.DanceAcademyContext> DbFactory

<PageTitle>Branches - Dance Academy</PageTitle>

<div class="page-header">
    <h1><i class="bi bi-building me-2"></i>Branches</h1>
    <p>Manage dance academy locations</p>
    <div class="page-header-actions">
        <a href="branches/create" class="btn btn-light">
            <i class="bi bi-plus-lg"></i> Add New Branch
        </a>
    </div>
</div>

<div class="table-container">
    <div class="table-toolbar">
        <div class="table-search">
            <i class="bi bi-search"></i>
            <input type="text" placeholder="Search branches..." @bind="searchTerm" @bind:event="oninput" @bind:after="OnSearchChanged" />
        </div>
        <div class="text-muted">
            @if (branchCount > 0)
            {
                <span>@branchCount branch(es) found</span>
            }
        </div>
    </div>
    
    @if (branches == null)
    {
        <div class="loading-spinner">
            <div class="spinner"></div>
            <span>Loading branches...</span>
        </div>
    }
    else if (!branches.Any())
    {
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="bi bi-building"></i>
            </div>
            <div class="empty-state-title">No branches yet</div>
            <p class="empty-state-text">Get started by adding your first branch location.</p>
            <a href="branches/create" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> Add First Branch
            </a>
        </div>
    }
    else
    {
        <table class="modern-table">
            <thead>
                <tr>
                    <th>Branch</th>
                    <th>Location</th>
                    <th>Contact</th>
                    <th>Capacity</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var branch in branches)
                {
                    <tr>
                        <td>
                            <div class="member-name">
                                <div class="member-avatar">
                                    @GetInitials(branch.branch_name)
                                </div>
                                <div class="member-info">
                                    <span class="member-fullname">@branch.branch_name</span>
                                    <span class="member-email">@branch.branch_district</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>
                                <strong>@branch.branch_city</strong>
                                <div class="text-muted" style="font-size: 0.85rem;">@TruncateText(branch.branch_address, 35)</div>
                            </div>
                        </td>
                        <td>@(branch.branch_contact_number ?? "-")</td>
                        <td>
                            @if (branch.branch_capacity.HasValue)
                            {
                                <span class="badge-capacity">@branch.branch_capacity people</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            <div class="table-actions">
                                <a href="@($"branches/details?id={branch.ID}")" class="btn-action btn-action-view" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="@($"branches/edit?id={branch.ID}")" class="btn-action btn-action-edit" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="@($"branches/delete?id={branch.ID}")" class="btn-action btn-action-delete" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

<style>
    .badge-capacity {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        background: #e8f5e9;
        color: #2e7d32;
    }
</style>

@code {
    private DanceAcademyContext context = default!;
    private List<BRANCH>? branches;
    private int branchCount;
    private string searchTerm = "";

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();
        await LoadBranches();
    }

    private async Task OnSearchChanged()
    {
        await LoadBranches();
    }

    private async Task LoadBranches()
    {
        var query = context.BRANCH.AsQueryable();
        
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.ToLower();
            query = query.Where(b => 
                (b.branch_name != null && b.branch_name.ToLower().Contains(term)) ||
                (b.branch_city != null && b.branch_city.ToLower().Contains(term)) ||
                (b.branch_district != null && b.branch_district.ToLower().Contains(term)) ||
                (b.branch_address != null && b.branch_address.ToLower().Contains(term)));
        }
        
        branches = await query
            .Select(b => new BRANCH 
            { 
                ID = b.ID, 
                branch_name = b.branch_name, 
                branch_city = b.branch_city,
                branch_address = b.branch_address,
                branch_district = b.branch_district,
                branch_contact_number = b.branch_contact_number,
                branch_capacity = b.branch_capacity
            })
            .ToListAsync();
            
        branchCount = branches.Count;
    }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return (parts[0][0].ToString() + parts[1][0].ToString()).ToUpper();
        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }

    private string TruncateText(string? text, int maxLength)
    {
        if (string.IsNullOrEmpty(text)) return "-";
        return text.Length <= maxLength ? text : text.Substring(0, maxLength) + "...";
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}
