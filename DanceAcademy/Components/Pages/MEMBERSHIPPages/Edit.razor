@page "/memberships/edit"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using DataAccess
@inject IDbContextFactory<DanceAcademy.Data.DanceAcademyContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Edit Membership - Dance Academy</PageTitle>

<div class="page-header">
    <h1><i class="bi bi-pencil-square me-2"></i>Edit Membership</h1>
    <p>Update membership details</p>
</div>

@if (Membership is null)
{
    <div class="loading-spinner">
        <div class="spinner"></div>
        <span>Loading membership details...</span>
    </div>
}
else
{
    <EditForm Model="Membership" OnValidSubmit="UpdateMembership" FormName="EditMembership">
        <DataAnnotationsValidator />
        <ValidationSummary class="alert alert-danger" role="alert"/>
        <input type="hidden" name="Membership.ID" value="@Membership.ID" />
        
        <div class="form-section">
            <h3 class="form-section-title"><i class="bi bi-person me-2"></i>Member & Branch</h3>
            <div class="form-row">
                <div class="mb-3">
                    <label for="memberid" class="form-label">Member</label>
                    <InputSelect id="memberid" @bind-Value="Membership.MEMBERID" class="form-control">
                        <option value="0">Select a member...</option>
                        @if (members != null)
                        {
                            @foreach (var member in members)
                            {
                                <option value="@member.ID">@member.member_first_name @member.member_last_name</option>
                            }
                        }
                    </InputSelect>
                    <ValidationMessage For="() => Membership.MEMBERID" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="branchid" class="form-label">Branch</label>
                    <InputSelect id="branchid" @bind-Value="Membership.BRANCHID" class="form-control">
                        <option value="0">Select a branch...</option>
                        @if (branches != null)
                        {
                            @foreach (var branch in branches)
                            {
                                <option value="@branch.ID">@branch.branch_name</option>
                            }
                        }
                    </InputSelect>
                    <ValidationMessage For="() => Membership.BRANCHID" class="text-danger" />
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3 class="form-section-title"><i class="bi bi-card-list me-2"></i>Membership Details</h3>
            <div class="form-row">
                <div class="mb-3">
                    <label for="membership_type" class="form-label">Membership Type</label>
                    <InputSelect id="membership_type" @bind-Value="Membership.membership_type" class="form-control">
                        <option value="">Select type...</option>
                        <option value="Basic">Basic</option>
                        <option value="Standard">Standard</option>
                        <option value="Premium">Premium</option>
                        <option value="VIP">VIP</option>
                    </InputSelect>
                    <ValidationMessage For="() => Membership.membership_type" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="fee_amount" class="form-label">Fee Amount</label>
                    <InputNumber id="fee_amount" @bind-Value="Membership.fee_amount" class="form-control" placeholder="0.00" />
                    <ValidationMessage For="() => Membership.fee_amount" class="text-danger" />
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3 class="form-section-title"><i class="bi bi-calendar-range me-2"></i>Duration</h3>
            <div class="form-row">
                <div class="mb-3">
                    <label for="start_date" class="form-label">Start Date</label>
                    <InputDate id="start_date" @bind-Value="Membership.start_date" class="form-control" />
                    <ValidationMessage For="() => Membership.start_date" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="end_date" class="form-label">End Date</label>
                    <InputDate id="end_date" @bind-Value="Membership.end_date" class="form-control" />
                    <ValidationMessage For="() => Membership.end_date" class="text-danger" />
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg"></i> Save Changes
            </button>
            <a href="/memberships" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
        </div>
    </EditForm>
}

@code {
    [SupplyParameterFromQuery]
    private int ID { get; set; }

    private MEMBERSHIP? Membership { get; set; }
    private List<MEMBER>? members;
    private List<BRANCH>? branches;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        
        members = await context.MEMBER
            .Select(m => new MEMBER { ID = m.ID, member_first_name = m.member_first_name, member_last_name = m.member_last_name })
            .ToListAsync();
        branches = await context.BRANCH
            .Select(b => new BRANCH { ID = b.ID, branch_name = b.branch_name })
            .ToListAsync();

        Membership = await context.MEMBERSHIP
            .Where(ms => ms.ID == ID)
            .Select(ms => new MEMBERSHIP
            {
                ID = ms.ID,
                MEMBERID = ms.MEMBERID,
                BRANCHID = ms.BRANCHID,
                membership_type = ms.membership_type,
                start_date = ms.start_date,
                end_date = ms.end_date,
                fee_amount = ms.fee_amount
            })
            .FirstOrDefaultAsync();

        if (Membership is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private async Task UpdateMembership()
    {
        using var context = DbFactory.CreateDbContext();
        context.Attach(Membership!).State = EntityState.Modified;

        try
        {
            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!MembershipExists(Membership!.ID))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }

        NavigationManager.NavigateTo("/memberships");
    }

    private bool MembershipExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return context.MEMBERSHIP.Any(e => e.ID == id);
    }
}
