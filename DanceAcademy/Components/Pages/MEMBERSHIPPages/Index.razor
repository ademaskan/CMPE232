@page "/memberships"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using DataAccess
@using DanceAcademy.Data
@implements IAsyncDisposable
@inject IDbContextFactory<DanceAcademy.Data.DanceAcademyContext> DbFactory

<PageTitle>Memberships - Dance Academy</PageTitle>

<div class="page-header">
    <h1><i class="bi bi-card-checklist me-2"></i>Memberships</h1>
    <p>Manage member subscriptions and plans</p>
    <div class="page-header-actions">
        <a href="memberships/create" class="btn btn-light">
            <i class="bi bi-plus-lg"></i> Add New Membership
        </a>
    </div>
</div>

<div class="table-container">
    <div class="table-toolbar">
        <div class="table-search">
            <i class="bi bi-search"></i>
            <input type="text" placeholder="Search memberships..." @bind="searchTerm" @bind:event="oninput" @bind:after="OnSearchChanged" />
        </div>
        <div class="text-muted">
            @if (membershipCount > 0)
            {
                <span>@membershipCount membership(s) found</span>
            }
        </div>
    </div>
    
    @if (memberships == null)
    {
        <div class="loading-spinner">
            <div class="spinner"></div>
            <span>Loading memberships...</span>
        </div>
    }
    else if (!memberships.Any())
    {
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="bi bi-card-checklist"></i>
            </div>
            <div class="empty-state-title">No memberships yet</div>
            <p class="empty-state-text">Get started by creating your first membership plan.</p>
            <a href="memberships/create" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> Add First Membership
            </a>
        </div>
    }
    else
    {
        <table class="modern-table">
            <thead>
                <tr>
                    <th>Member</th>
                    <th>Branch</th>
                    <th>Type</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Status</th>
                    <th>Fee</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var ms in memberships)
                {
                    <tr>
                        <td>
                            <div class="member-name">
                                <div class="member-avatar">
                                    @GetInitials(ms.MemberName)
                                </div>
                                <div class="member-info">
                                    <span class="member-fullname">@ms.MemberName</span>
                                    <span class="member-email">ID: @ms.MEMBERID</span>
                                </div>
                            </div>
                        </td>
                        <td>@ms.BranchName</td>
                        <td>
                            <span class="badge-type @GetTypeBadgeClass(ms.membership_type)">
                                @ms.membership_type
                            </span>
                        </td>
                        <td>@ms.start_date.ToString("MMM dd, yyyy")</td>
                        <td>@ms.end_date.ToString("MMM dd, yyyy")</td>
                        <td>
                            <span class="badge-status @GetStatusBadgeClass(ms.end_date)">
                                @GetStatus(ms.end_date)
                            </span>
                        </td>
                        <td><strong>@ms.fee_amount.ToString("C")</strong></td>
                        <td>
                            <div class="table-actions">
                                <a href="@($"memberships/details?id={ms.ID}")" class="btn-action btn-action-view" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="@($"memberships/edit?id={ms.ID}")" class="btn-action btn-action-edit" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="@($"memberships/delete?id={ms.ID}")" class="btn-action btn-action-delete" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

<style>
    .badge-type {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        background: #e3f2fd;
        color: #1565c0;
    }
    .badge-type-premium {
        background: #fff3e0;
        color: #e65100;
    }
    .badge-type-basic {
        background: #e8f5e9;
        color: #2e7d32;
    }
    .badge-status {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .badge-status-active {
        background: #e8f5e9;
        color: #2e7d32;
    }
    .badge-status-expired {
        background: #ffebee;
        color: #c62828;
    }
    .badge-status-expiring {
        background: #fff3e0;
        color: #e65100;
    }
</style>

@code {
    private DanceAcademyContext context = default!;
    private List<MembershipViewModel>? memberships;
    private int membershipCount;
    private string searchTerm = "";

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();
        await LoadMemberships();
    }

    private async Task OnSearchChanged()
    {
        await LoadMemberships();
    }

    private async Task LoadMemberships()
    {
        var query = context.MEMBERSHIP
            .Include(ms => ms.MEMBER)
            .Include(ms => ms.BRANCH)
            .AsQueryable();
        
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.ToLower();
            query = query.Where(ms => 
                (ms.MEMBER.member_first_name != null && ms.MEMBER.member_first_name.ToLower().Contains(term)) ||
                (ms.MEMBER.member_last_name != null && ms.MEMBER.member_last_name.ToLower().Contains(term)) ||
                (ms.BRANCH.branch_name != null && ms.BRANCH.branch_name.ToLower().Contains(term)) ||
                (ms.membership_type != null && ms.membership_type.ToLower().Contains(term)));
        }
        
        memberships = await query
            .Select(ms => new MembershipViewModel 
            { 
                ID = ms.ID, 
                MEMBERID = ms.MEMBERID,
                MemberName = ms.MEMBER.member_first_name + " " + ms.MEMBER.member_last_name,
                BRANCHID = ms.BRANCHID,
                BranchName = ms.BRANCH.branch_name ?? "Unknown",
                membership_type = ms.membership_type,
                start_date = ms.start_date,
                end_date = ms.end_date,
                fee_amount = ms.fee_amount
            })
            .ToListAsync();
            
        membershipCount = memberships.Count;
    }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return (parts[0][0].ToString() + parts[1][0].ToString()).ToUpper();
        return parts[0][0].ToString().ToUpper();
    }

    private string GetTypeBadgeClass(string? type)
    {
        return type?.ToLower() switch
        {
            "premium" or "gold" or "vip" => "badge-type-premium",
            "basic" or "standard" => "badge-type-basic",
            _ => ""
        };
    }

    private string GetStatusBadgeClass(DateTime endDate)
    {
        var daysRemaining = (endDate - DateTime.Today).TotalDays;
        if (daysRemaining < 0) return "badge-status-expired";
        if (daysRemaining <= 30) return "badge-status-expiring";
        return "badge-status-active";
    }

    private string GetStatus(DateTime endDate)
    {
        var daysRemaining = (endDate - DateTime.Today).TotalDays;
        if (daysRemaining < 0) return "Expired";
        if (daysRemaining <= 30) return "Expiring Soon";
        return "Active";
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();

    private class MembershipViewModel
    {
        public int ID { get; set; }
        public int MEMBERID { get; set; }
        public string MemberName { get; set; } = "";
        public int BRANCHID { get; set; }
        public string BranchName { get; set; } = "";
        public string membership_type { get; set; } = "";
        public DateTime start_date { get; set; }
        public DateTime end_date { get; set; }
        public decimal fee_amount { get; set; }
    }
}
