@page "/branch_performances/delete"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using DataAccess
@inject IDbContextFactory<DanceAcademy.Data.DanceAcademyContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Delete Performance Record - Dance Academy</PageTitle>

<div class="page-header" style="background: linear-gradient(135deg, #ef5350 0%, #c62828 100%);">
    <h1><i class="bi bi-trash me-2"></i>Delete Performance Record</h1>
    <p>Remove a performance record from the system</p>
</div>

@if (performance is null)
{
    <div class="loading-spinner">
        <div class="spinner"></div>
        <span>Loading performance data...</span>
    </div>
}
else
{
    <div class="delete-warning">
        <div class="delete-warning-icon">
            <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <div class="delete-warning-title">Are you sure you want to delete this performance record?</div>
        <p class="delete-warning-text">This action cannot be undone. The financial data will be permanently removed.</p>
    </div>

    <div class="content-card">
        <div class="content-card-header">
            <div>
                <h2 class="content-card-title mb-0">@branchName</h2>
                <span class="text-muted">@GetMonthName(performance.month) @performance.year</span>
            </div>
        </div>
        
        <div class="details-grid">
            <div class="detail-item">
                <div class="detail-label">Branch</div>
                <div class="detail-value">@branchName</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Period</div>
                <div class="detail-value">@GetMonthName(performance.month) @performance.year</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Revenue</div>
                <div class="detail-value" style="color: #2e7d32;">@performance.revenue.ToString("C")</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Expenses</div>
                <div class="detail-value" style="color: #c62828;">@performance.expenses.ToString("C")</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Net Profit</div>
                <div class="detail-value">@(performance.net_profit?.ToString("C") ?? "-")</div>
            </div>
        </div>
    </div>

    <div class="form-actions">
        <EditForm Model="performance" OnValidSubmit="DeletePerformance" FormName="DeletePerformance">
            <button type="submit" class="btn btn-danger">
                <i class="bi bi-trash"></i> Yes, Delete Record
            </button>
        </EditForm>
        <a href="/branch_performances" class="btn btn-secondary">
            <i class="bi bi-x-lg"></i> Cancel
        </a>
    </div>
}

@code {
    private BRANCH_PERFORMANCE? performance;
    private string branchName = "";

    [SupplyParameterFromQuery]
    private int ID { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        
        var data = await context.BRANCH_PERFORMANCE
            .Where(bp => bp.ID == ID)
            .Select(bp => new 
            {
                Performance = new BRANCH_PERFORMANCE
                {
                    ID = bp.ID,
                    BRANCHID = bp.BRANCHID,
                    month = bp.month,
                    year = bp.year,
                    revenue = bp.revenue,
                    expenses = bp.expenses,
                    net_profit = bp.net_profit
                },
                BranchName = bp.BRANCH.branch_name
            })
            .FirstOrDefaultAsync();

        if (data is null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        performance = data.Performance;
        branchName = data.BranchName ?? "Unknown";
    }

    private async Task DeletePerformance()
    {
        using var context = DbFactory.CreateDbContext();
        context.BRANCH_PERFORMANCE.Remove(performance!);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/branch_performances");
    }

    private string GetMonthName(int month)
    {
        return month switch
        {
            1 => "January", 2 => "February", 3 => "March", 4 => "April",
            5 => "May", 6 => "June", 7 => "July", 8 => "August",
            9 => "September", 10 => "October", 11 => "November", 12 => "December",
            _ => $"Month {month}"
        };
    }
}
